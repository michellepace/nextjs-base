# Lefthook configuration for Git hooks
# https://lefthook.dev/

# Use doublestar glob matcher for standard glob behaviour (** matches 0 or more directories)
glob_matcher: doublestar

pre-commit:
  parallel: false # Sequential: type-check and tests must run on biome-fixed code

  skip: # Skip pre-commit hooks in these situations
    - merge   # Merge commits combine already-tested code
    - rebase  # Commits are replayed during rebase, already tested
    - run: test "$CI" = "true" # Skip in GitHub Actions; pre-commit hooks ran locally

  commands:

    npm-install: # Sync package-lock.json when package.json changes
      glob: "package.json"
      run: npm install && git add package-lock.json

    biome-check: # Biome: lint, format, import organisation (config in biome.json)
      # NB: runs on every commit, optimise when it gets slow
      run: npx @biomejs/biome check --write --error-on-warnings --no-errors-on-unmatched --files-ignore-unknown=true {staged_files}
      stage_fixed: true # Include fixes in commit (--write applies safe fixes)

    type-check: # TypeScript type checking (config in tsconfig.json)
      # NB: runs on every commit, optimise when it gets slow
      run: npx tsc --noEmit

    unit-tests: # Vitest: run unit tests (when matching files change)
      glob:
        - "**/*.{ts,tsx,js,jsx}"
        - "package.json"
        - "package-lock.json"
        - "tsconfig.json"
        - "next.config.ts"
        - "vitest.setup.ts"
        - "vitest.config.ts"
        - "middleware.ts"       # Next.js Edge middleware
        - "instrumentation.ts"  # Next.js observability hooks
      run: npx vitest run