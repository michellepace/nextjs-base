# Lefthook configuration for Git hooks
# https://lefthook.dev/

# Use doublestar glob matcher for standard glob behaviour (** matches 0 or more directories)
glob_matcher: doublestar

pre-commit:
  parallel: false # Sequential: type-check and tests must run on biome-fixed code

  skip:
  # Skip pre-commit hooks in these situations
    - merge   # Merge commits combine already-tested code
    - rebase  # Commits are replayed during rebase, already tested

  commands:

    npm-install:
    # Sync and add package-lock.json (when package.json changes)
      glob: "package.json"
      run: npm install && git add package-lock.json

    biome-check:
    # Biome: lint, format, imports, apply safe fixes (every commit)
    # config: biome.json
      run: npx @biomejs/biome check --write --error-on-warnings --no-errors-on-unmatched --files-ignore-unknown=true {staged_files}
      stage_fixed: true

    type-check:
    # TypeScript type checking (every commit)
    # config: tsconfig.json
      run: npx tsc --noEmit --pretty

    unit-tests:
    # Vitest: run unit tests (when matching files change)
      glob:
        - "**/*.{ts,tsx}" # code in folders
        - "!e2e/**/*" # Exclude e2e tests
        - "package-lock.json" # Dependency changes
        - "vitest.config.ts" # Config
      run: npx vitest run

pre-push:
  parallel: false # `npm run build` locks, avoid race condition for Playwright

  commands:
    build:
    # Production build catches static generation errors (e.g. missing Suspense)
      run: npm run build

    playwright-tests:
    # Playwright: E2E tests (when matching files change).
      glob:
        - "**/*.{ts,tsx,css}" # code in folders
        - "!**/*.{test,spec}.{ts,tsx}" # Exclude unit tests
        - "package-lock.json" # Dependency changes
        - "postcss.config.mjs" # CSS processing
        - "playwright.config.ts" # Config
      run: npx playwright test